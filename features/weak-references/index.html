<!doctype html><html lang=zh-CN><meta charset=utf-8><title>Weak references and finalizers · V8</title><meta content="width=device-width,initial-scale=1" name=viewport><meta content="dark light" name=color-scheme><link href=/_css/main.css rel=stylesheet><link href=/_css/feature-support.css rel=stylesheet><link href=/.webmanifest rel=manifest><meta content=#4285F4 name=theme-color><link href=/blog.atom rel=alternate title="V8 Atom feed" type=application/atom+xml><link href=/features.atom rel=alternate title="V8 JS/Wasm features Atom feed" type=application/atom+xml><script>document.documentElement.className+=' js'</script><meta content="Weak references and finalizers are coming to JavaScript! This article explains the new functionality." name=description><header id=header><h1><a href=/ >V8</a></h1><a href=#navigation-toggle id=nav-toggle>显示导肮</a><nav><ul><li><a href=/ >主页</a><li><a href=/blog/ >博客</a><li><a href=/docs/ >文档</a><li class=current><a href=/features title="JavaScript 和 WebAssembly 的新特性">JS/Wasm 新特性</a></ul></nav></header><main id=main><article itemscope itemtype=http://schema.org/BlogPosting><header><h1 itemprop=headline>Weak references and finalizers</h1><p class=meta>发布时间：<time datetime="2019-07-09 00:00:00" itemprop=datePublished>2019-07-09</time> · 标签： <a href=/features/tags/ecmascript class=tag>ECMAScript</a></header><div itemprop=articleBody><p>Generally, references to objects are <em>strongly held</em> in JavaScript, meaning that as long you have a reference to the object, it won’t be garbage-collected.<pre class=language-js><code class=language-js><span class=highlight-line><span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">42</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">51</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token comment">// As long as you have access to `ref` (or any other reference to the</span></span><br><span class=highlight-line><span class="token comment">// same object), the object won’t be garbage-collected.</span></span></code></pre><p>Currently, <code>WeakMap</code>s and <code>WeakSet</code>s are the only way to kind-of-weakly reference an object in JavaScript: adding an object as a key to a <code>WeakMap</code> or <code>WeakSet</code> doesn’t prevent it from being garbage-collected.<pre class=language-js><code class=language-js><span class=highlight-line><span class="token keyword">const</span> wm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token keyword">const</span> metaData <span class="token operator">=</span> <span class="token string">'foo'</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  wm<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ref<span class="token punctuation">,</span> metaData<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  wm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token comment">// → metaData</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span><br><span class=highlight-line><span class="token comment">// We no longer have a reference to `ref` in this block scope, so it</span></span><br><span class=highlight-line><span class="token comment">// can be garbage-collected now, even though it’s a key in `wm` to</span></span><br><span class=highlight-line><span class="token comment">// which we still have access.</span></span><br><span class=highlight-line></span><br><span class=highlight-line><span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  ws<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  ws<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token comment">// → true</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span><br><span class=highlight-line><span class="token comment">// We no longer have a reference to `ref` in this block scope, so it</span></span><br><span class=highlight-line><span class="token comment">// can be garbage-collected now, even though it’s a key in `ws` to</span></span><br><span class=highlight-line><span class="token comment">// which we still have access.</span></span></code></pre><div class=note><p>You can think of <code>WeakMap.prototype.set(ref, metaData)</code> as adding a property with the value <code>metaData</code> to the object <code>ref</code>: as long as you have a reference to the object, you can get the metadata. Once you no longer have a reference to the object, it can be garbage-collected, even if you still have a reference to the <code>WeakMap</code> to which it was added. Similarly, you can think of a <code>WeakSet</code> as a special case of <code>WeakMap</code> where all the values are booleans.<p>A JavaScript <code>WeakMap</code> is not really <em>weak</em>: it actually refers <em>strongly</em> to its contents as long as the key is alive. The <code>WeakMap</code> only refers weakly to its contents once the key is garbage-collected. A more accurate name for this kind of relationship is <a href=https://en.wikipedia.org/wiki/Ephemeron><em>ephemeron</em></a>.</div><p><code>WeakRef</code> is a more advanced API that provides <em>actual</em> weak references, enabling a window into the lifetime of an object. Let’s walk through an example together.<p>Imagine a <code>getImage</code> function that takes a <code>name</code> and performs some expensive operation to generate another object, like a binary blob of image data:<pre class=language-js><code class=language-js><span class=highlight-line><span class="token keyword">function</span> <span class="token function">getImage</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token function">performExpensiveOperation</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token keyword">return</span> image<span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span></code></pre><p>To improve performance, we store the image in a cache. Now, we don’t have to perform the expensive operation again for the same name!<pre class=language-js><code class=language-js><span class=highlight-line><span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line></span><br><span class=highlight-line><span class="token keyword">function</span> <span class="token function">getImageCached</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token function">performExpensiveOperation</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token keyword">return</span> image<span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span></code></pre><p>But, there’s a problem here. <code>Map</code>s hold on to their keys and values strongly, and so the image names and data can never be garbage-collected. This steadily increases memory and causes a <strong>memory leak</strong>!<p><code>WeakRef</code>s make it possible to solve the memory leak by creating a <em>weak reference</em> to the image and storing <em>that</em> in the cache (instead of the image itself). This way, the garbage collector can clean up the images that do not have a strong reference.<pre class=language-js><code class=language-js><span class=highlight-line><span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line></span><br><span class=highlight-line><span class="token keyword">function</span> <span class="token function">getImageCached</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token keyword">const</span> ref <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>    <span class="token keyword">const</span> deref <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    <span class="token keyword">if</span> <span class="token punctuation">(</span>deref <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> deref<span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token punctuation">}</span></span><br><span class=highlight-line>  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token function">performExpensiveOperation</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token keyword">const</span> wr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRef</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> wr<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token keyword">return</span> image<span class="token punctuation">;</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span></code></pre><p>But there’s still a problem here: the <code>Map</code> still holds on to the <code>name</code> strings forever, because those are the keys in the cache. Ideally, those strings would be removed too. The <code>WeakRef</code> proposal has a solution for this as well! With the new <code>FinalizationGroup</code> API, we can register a callback to run when the garbage collector zaps a registered object. Such callbacks are known as <em>finalizers</em>.<div class=note><p><strong>Note:</strong> The finalization callback does not run immediately after garbage-collecting the image object. It either runs at some point in the future, or not at all — the spec doesn’t guarantee that it runs! Keep this in mind when writing code.</div><p>Here, we register a callback to remove keys from the cache when the image objects are garbage-collected:<pre class=language-js><code class=language-js><span class=highlight-line><span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line></span><br><span class=highlight-line><span class="token keyword">const</span> finalizationGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalizationGroup</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">iterator</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">of</span> iterator<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>    <span class="token keyword">const</span> ref <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&&</span> ref<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>      cache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    <span class="token punctuation">}</span></span><br><span class=highlight-line>  <span class="token punctuation">}</span></span><br><span class=highlight-line><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre><div class=note><p><strong>Note:</strong> The <code>ref !== undefined && ref.deref() === undefined</code> is required because we could’ve added a new <code>WeakRef</code> with the same <code>name</code> between the old <code>WeakRef</code> enqueueing the finalization callback and actually running the finalization callback.</div><p>Our final implementation looks like this:<pre class=language-js><code class=language-js><span class=highlight-line><span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line></span><br><span class=highlight-line><span class="token keyword">const</span> finalizationGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalizationGroup</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">iterator</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">of</span> iterator<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>    <span class="token keyword">const</span> ref <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&&</span> ref<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>      cache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    <span class="token punctuation">}</span></span><br><span class=highlight-line>  <span class="token punctuation">}</span></span><br><span class=highlight-line><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line></span><br><span class=highlight-line><span class="token keyword">function</span> <span class="token function">getImageCached</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class=highlight-line>  <span class="token keyword">const</span> ref <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span></span><br><span class=highlight-line>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 2</span></span><br><span class=highlight-line>    <span class="token keyword">const</span> deref <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class=highlight-line>    <span class="token keyword">if</span> <span class="token punctuation">(</span>deref <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> deref<span class="token punctuation">;</span></span><br><span class=highlight-line>  <span class="token punctuation">}</span></span><br><span class=highlight-line>  <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token function">performExpensiveOperation</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span></span><br><span class=highlight-line>  <span class="token keyword">const</span> wr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakRef</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span></span><br><span class=highlight-line>  cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> wr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span></span><br><span class=highlight-line>  finalizationGroup<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span></span><br><span class=highlight-line>  <span class="token keyword">return</span> image<span class="token punctuation">;</span> <span class="token comment">// 7</span></span><br><span class=highlight-line><span class="token punctuation">}</span></span></code></pre><p>Given an image name, we look up its corresponding weak reference in the cache (1). If the weak reference still points to something (2), we can return the cached image data. If there’s no cache entry yet for this image name, or if the cached image data has been garbage-collected, we compute the image data (3), create a new weak reference to it (4), store the image name and the weak reference in the cache (5), register a finalizer that removes the image name from the cache once the image data is garbage-collected (6), and return the image (7).<h2 id=progressive-enhancement>Don’t overdo it <a href=#progressive-enhancement class=bookmark>#</a></h2><p>After hearing about these new capabilities, it might be tempting to <code>WeakRef</code> All The Things™. However, that’s probably not a good idea. Some things are explicitly <em>not</em> good use cases for <code>WeakRef</code>s and finalizers.<p>In general, avoid writing code that depends on the garbage collector cleaning up a <code>WeakRef</code> or calling a finalizer at any predictable time — <a href=https://github.com/tc39/proposal-weakrefs#a-note-of-caution>it can’t be done</a>!<p>For example, don’t place important logic in the code path of a finalizer. There’s no way to predict <em>when</em>, or even <em>if</em>, a given finalizer gets called. It’s best to think of <code>WeakRef</code>s and finalizers as <strong>progressive enhancement</strong>: it’s nice if your custom finalizer code runs, but your program should still work without it.<p><code>WeakRef</code>s and finalizers can help you save memory, and work best when used sparingly as a means of progressive enhancement. Since they’re power-user features, we expect most usage to happen within frameworks or libraries.<h2 id=support><code>WeakRef</code> support <a href=#support class=bookmark>#</a></h2><ul class=feature-support><li class="environment no-support"><span class="icon chrome">Chrome:</span> <span class=support>不支持</span><li class="environment no-support"><span class="icon firefox">Firefox:</span> <span class=support>不支持</span><li class="environment no-support"><span class="icon safari">Safari:</span> <span class=support>不支持</span><li class="environment no-support"><span class="icon nodejs">Node.js:</span> <span class=support>不支持</span><li class="environment no-support"><span class="icon babel">Babel:</span> <span class=support>不支持</span></ul><div class=feature-support-info><a href=/features/support>关于特性支持列表</a></div></div><footer><div><img alt="" height=96 loading=lazy src=/_img/avatars/sathya-gunasekaran.jpg srcset="/_img/avatars/sathya-gunasekaran@2x.jpg 2x" width=96> <img alt="" height=96 loading=lazy src=/_img/avatars/mathias-bynens.jpg srcset="/_img/avatars/mathias-bynens@2x.jpg 2x" width=96><p>作者：Sathya Gunasekaran (<a href=https://twitter.com/_gsathya>@_gsathya</a>) and Mathias Bynens (<a href=https://twitter.com/mathias>@mathias</a>).</div><a href=https://twitter.com/v8js/status/1148603966848151553 class=retweet>Retweet this article!</a></footer></article></main><footer id=footer><div><nav><a href=https://v8.dev/features/weak-references>原文</a> · <a href=/logo/ >商标</a> · <a href=/terms/ >条款</a> · <a href=https://policies.google.com/privacy/ >隐私</a> · <a href=https://twitter.com/v8js rel="me nofollow">Twitter</a> · <a href=https://github.com/justjavac/v8.js.cn/tree/master/./src/features/weak-references.md rel=nofollow>在 GitHub 编辑此页面</a></nav><dark-mode-toggle dark="Light Theme" light="Dark Theme" permanent></dark-mode-toggle></div><p><small>如无特殊说明，此 V8 项目中使用到的所有示例代码均基于 <a href=https://chromium.googlesource.com/v8/v8.git/+/master/LICENSE>V8's BSD-style license</a> 发布。页面中的文字内容采用 <a href=https://creativecommons.org/licenses/by/3.0/ >the Creative Commons Attribution 3.0 License</a> 进行许可。更详细的信息可以在 <a href=/terms#site-policies>站点策略</a> 中找到。</small></footer><script src=/_js/main.mjs type=module></script><script src=/_js/legacy.js nomodule></script>